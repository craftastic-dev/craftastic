# Git Architecture Diagram

## System Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Craftastic Git Integration                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚   Browser   â”‚â—€â”€â”€â”€â”€â–¶â”‚  Craftastic  â”‚â—€â”€â”€â”€â”€â–¶â”‚     GitHub     â”‚         â”‚
â”‚  â”‚             â”‚      â”‚   Backend    â”‚      â”‚   OAuth API    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                     â”‚                                          â”‚
â”‚         â”‚                     â”‚                                          â”‚
â”‚         â–¼                     â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚  â”‚   Git UI    â”‚      â”‚  PostgreSQL  â”‚                                 â”‚
â”‚  â”‚   Panel     â”‚      â”‚              â”‚                                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  - users     â”‚                                 â”‚
â”‚                       â”‚  - tokens    â”‚                                 â”‚
â”‚                       â”‚  - repos     â”‚                                 â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Worktree Architecture

```
Host Filesystem
/data/craftastic/
â””â”€â”€ repos/
    â””â”€â”€ {environment_id}/
        â”œâ”€â”€ .git/                    # Bare repository (shared)
        â””â”€â”€ worktrees/
            â”œâ”€â”€ {session_1}/         # Worktree for session 1
            â”‚   â”œâ”€â”€ src/
            â”‚   â”œâ”€â”€ package.json
            â”‚   â””â”€â”€ ...
            â”œâ”€â”€ {session_2}/         # Worktree for session 2
            â”‚   â”œâ”€â”€ src/
            â”‚   â”œâ”€â”€ package.json
            â”‚   â””â”€â”€ ...
            â””â”€â”€ {session_3}/         # Worktree for session 3
                â”œâ”€â”€ src/
                â”œâ”€â”€ package.json
                â””â”€â”€ ...

Docker Containers
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Container 1        â”‚
â”‚  /workspace â—€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ Mount: /data/.../worktrees/{session_1}
â”‚  Branch: main       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Container 2        â”‚
â”‚  /workspace â—€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ Mount: /data/.../worktrees/{session_2}
â”‚  Branch: feature/x  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Container 3        â”‚
â”‚  /workspace â—€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€ Mount: /data/.../worktrees/{session_3}
â”‚  Branch: bugfix/y   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Session Lifecycle

```
1. Create Environment
   â”‚
   â”œâ”€â–¶ Clone bare repo
   â”‚   git clone --bare {repo_url} /data/craftastic/repos/{env_id}/.git
   â”‚
   â””â”€â–¶ Store in DB
       environments.repository_url = {repo_url}

2. Create Session
   â”‚
   â”œâ”€â–¶ Create worktree
   â”‚   git worktree add /data/.../worktrees/{session_id} {branch}
   â”‚
   â”œâ”€â–¶ Create container
   â”‚   docker run -v {worktree_path}:/workspace ...
   â”‚
   â””â”€â–¶ Pass credentials
       ENV GITHUB_TOKEN={encrypted_token}

3. Git Operations
   â”‚
   â”œâ”€â–¶ From UI: API calls to backend
   â”‚   POST /api/git/commit
   â”‚   POST /api/git/push
   â”‚
   â””â”€â–¶ From Terminal: Direct git commands
       git add .
       git commit -m "..."
       git push

4. Delete Session
   â”‚
   â”œâ”€â–¶ Stop container
   â”‚   docker stop {container_id}
   â”‚
   â”œâ”€â–¶ Remove worktree
   â”‚   git worktree remove {worktree_path}
   â”‚
   â””â”€â–¶ Clean up DB
       DELETE FROM sessions WHERE id = {session_id}
```

## Git Panel UI Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Environment View                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       â”‚         Git Panel                â”‚
â”‚                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     Terminal          â”‚  â”‚ ğŸ“ main (2 ahead)         â”‚  â”‚
â”‚                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                  â”‚
â”‚   $ npm run dev       â”‚  Modified Files:                â”‚
â”‚   Server started...   â”‚  â–¶ M  src/index.ts             â”‚
â”‚                       â”‚  â–¶ M  package.json             â”‚
â”‚                       â”‚  â–¶ ?  .env.local              â”‚
â”‚                       â”‚                                  â”‚
â”‚                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                       â”‚  â”‚ ğŸ’¬ Commit message...       â”‚  â”‚
â”‚                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                       â”‚                                  â”‚
â”‚                       â”‚  [Commit] [Push] [Pull]        â”‚
â”‚                       â”‚                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Data Flow

```
User Action          Backend Processing          Git Operation
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                                                 
Click "Commit"  â”€â”€â”€â–¶  /api/git/commit      â”€â”€â”€â–¶  git -C {path} commit
                      â”‚                           â”‚
                      â”œâ”€ Validate message         â”œâ”€ Set GIT_ASKPASS
                      â”œâ”€ Check worktree           â”œâ”€ Use stored token
                      â””â”€ Execute command          â””â”€ Return result
                                                 
View Status     â”€â”€â”€â–¶  /api/git/status      â”€â”€â”€â–¶  git -C {path} status
                      â”‚                           â”‚
                      â”œâ”€ Cache result             â”œâ”€ Parse output
                      â””â”€ Return JSON              â””â”€ Format for UI
                                                 
Push Changes    â”€â”€â”€â–¶  /api/git/push        â”€â”€â”€â–¶  git -C {path} push
                      â”‚                           â”‚
                      â”œâ”€ Check credentials        â”œâ”€ Use GitHub token
                      â”œâ”€ Set remote URL           â”œâ”€ Handle errors
                      â””â”€ Stream progress          â””â”€ Update UI
```